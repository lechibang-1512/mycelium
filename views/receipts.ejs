<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Inventory Management</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/style.css">
    
    <style>
        .receipt-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        
        .receipt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .export-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        .bulk-actions {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .receipt-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .advanced-filters {
            display: none;
        }
        
        .table-actions {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding: 10px;
            border-bottom: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="page-header primary">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="display-4">
                        <i class="fas fa-receipt me-3"></i>
                        Receipts Management
                    </h1>
                    <p class="lead">
                        Comprehensive receipt tracking and management system
                    </p>
                    
                    <!-- Enhanced Statistics -->
                    <div class="row">
                        <div class="col-md-2">
                            <div class="stat-card">
                                <h3><%= pagination.totalReceipts %></h3>
                                <p>Total Receipts</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <h3><%= receipts.filter(r => r.receipt_type === 'PURCHASE_RECEIPT').length %></h3>
                                <p>Purchase</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <h3><%= receipts.filter(r => r.receipt_type === 'SALES_RECEIPT').length %></h3>
                                <p>Sales</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>$<%= receipts.reduce((sum, r) => sum + parseFloat(r.total_amount || 0), 0).toLocaleString() %></h3>
                                <p>Total Value</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card analytics-card">
                                <h3><i class="fas fa-chart-line me-2"></i>Analytics</h3>
                                <p>View detailed insights</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Export Options -->
                <div class="export-options">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-0"><i class="fas fa-download me-2"></i>Export Options</h6>
                            <small class="text-muted">Export filtered receipts data</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-success btn-sm" onclick="exportData('excel')">
                                    <i class="fas fa-file-excel me-1"></i>Excel
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="exportData('pdf')">
                                    <i class="fas fa-file-pdf me-1"></i>PDF Report
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportData('csv')">
                                    <i class="fas fa-file-csv me-1"></i>CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-filter me-2"></i>Filter & Search Receipts
                                </h5>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedFilters()">
                                    <i class="fas fa-cog me-1"></i>Advanced
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="/receipts" class="row g-3" id="filterForm">
                            <!-- Quick Search -->
                            <div class="col-md-4">
                                <label for="searchTerm" class="form-label">Quick Search</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                                           placeholder="Receipt ID, supplier, product..." 
                                           value="<%= filters.searchTerm || '' %>">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Date Range -->
                            <div class="col-md-3">
                                <label for="dateRange" class="form-label">Date Range</label>
                                <select class="form-select" id="dateRange" name="dateRange" onchange="updateDateInputs()">
                                    <option value="custom">Custom Range</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="startDate" 
                                       value="<%= filters.startDate || '' %>">
                            </div>
                            <div class="col-md-2">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="endDate" 
                                       value="<%= filters.endDate || '' %>">
                            </div>
                            
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>

                            <!-- Advanced Filters Row -->
                            <div class="advanced-filters col-12">
                                <hr>
                                <div class="row g-3">
                                    <div class="col-md-2">
                                        <label for="receiptType" class="form-label">Type</label>
                                        <select class="form-select" id="receiptType" name="receiptType">
                                            <option value="all" <%= (filters.receiptType === 'all' || !filters.receiptType) ? 'selected' : '' %>>All Types</option>
                                            <option value="PURCHASE_RECEIPT" <%= filters.receiptType === 'PURCHASE_RECEIPT' ? 'selected' : '' %>>Purchase</option>
                                            <option value="SALES_RECEIPT" <%= filters.receiptType === 'SALES_RECEIPT' ? 'selected' : '' %>>Sales</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="supplierId" class="form-label">Supplier</label>
                                        <select class="form-select" id="supplierId" name="supplierId">
                                            <option value="">All Suppliers</option>
                                            <% suppliers.forEach(supplier => { %>
                                                <option value="<%= supplier.supplier_id %>" 
                                                        <%= filters.supplierId === supplier.supplier_id ? 'selected' : '' %>>
                                                    <%= supplier.name %>
                                                </option>
                                            <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="phoneId" class="form-label">Product</label>
                                        <select class="form-select" id="phoneId" name="phoneId">
                                            <option value="">All Products</option>
                                            <% phones.forEach(phone => { %>
                                                <option value="<%= phone.product_id %>" 
                                                        <%= filters.phoneId === phone.product_id ? 'selected' : '' %>>
                                                    <%= phone.device_maker %> <%= phone.device_name %>
                                                </option>
                                            <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="minAmount" class="form-label">Min Amount</label>
                                        <input type="number" class="form-control" id="minAmount" name="minAmount" 
                                               step="0.01" value="<%= filters.minAmount || '' %>">
                                    </div>
                                    <div class="col-md-2">
                                        <label for="maxAmount" class="form-label">Max Amount</label>
                                        <input type="number" class="form-control" id="maxAmount" name="maxAmount" 
                                               step="0.01" value="<%= filters.maxAmount || '' %>">
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label for="sortBy" class="form-label">Sort By</label>
                                        <select class="form-select" id="sortBy" name="sortBy">
                                            <option value="date_desc" <%= filters.sortBy === 'date_desc' ? 'selected' : '' %>>Date (Newest First)</option>
                                            <option value="date_asc" <%= filters.sortBy === 'date_asc' ? 'selected' : '' %>>Date (Oldest First)</option>
                                            <option value="amount_desc" <%= filters.sortBy === 'amount_desc' ? 'selected' : '' %>>Amount (Highest First)</option>
                                            <option value="amount_asc" <%= filters.sortBy === 'amount_asc' ? 'selected' : '' %>>Amount (Lowest First)</option>
                                            <option value="type" <%= filters.sortBy === 'type' ? 'selected' : '' %>>Type</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="itemsPerPage" class="form-label">Items per Page</label>
                                        <select class="form-select" id="itemsPerPage" name="limit">
                                            <option value="20" <%= (filters.limit || 20) == 20 ? 'selected' : '' %>>20</option>
                                            <option value="50" <%= filters.limit == 50 ? 'selected' : '' %>>50</option>
                                            <option value="100" <%= filters.limit == 100 ? 'selected' : '' %>>100</option>
                                        </select>
                                    </div>
                                    <div class="col-md-7 d-flex align-items-end">
                                        <a href="/receipts" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-times me-1"></i>Clear All
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-filter me-1"></i>Apply Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Bulk Actions Panel -->
                <div class="bulk-actions" id="bulkActions">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong><span id="selectedCount">0</span> receipts selected</strong>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group">
                                <button class="btn btn-outline-success" onclick="bulkExport()">
                                    <i class="fas fa-download me-1"></i>Export Selected
                                </button>
                                <button class="btn btn-outline-primary" onclick="bulkPrint()">
                                    <i class="fas fa-print me-1"></i>Print Selected
                                </button>
                                <button class="btn btn-outline-danger" onclick="bulkDelete()">
                                    <i class="fas fa-trash me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipts Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>Receipts List
                            <% if (pagination.totalReceipts > 0) { %>
                                <span class="badge bg-secondary"><%= pagination.totalReceipts %></span>
                            <% } %>
                        </h5>
                        <div class="btn-group">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="switchView('table')">
                                        <i class="fas fa-table me-2"></i>Table View
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="switchView('cards')">
                                        <i class="fas fa-th-large me-2"></i>Card View
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="switchView('compact')">
                                        <i class="fas fa-compress me-2"></i>Compact View
                                    </a></li>
                                </ul>
                            </div>
                            <a href="/inventory/receive" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-1"></i>New Purchase
                            </a>
                            <a href="/inventory/sell" class="btn btn-primary btn-sm">
                                <i class="fas fa-shopping-cart me-1"></i>New Sale
                            </a>
                        </div>
                    </div>
                    
                    <div class="table-actions">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    <label class="form-check-label" for="selectAll">
                                        Select All
                                    </label>
                                </div>
                            </div>
                            <div class="col-auto">
                                <small class="text-muted">
                                    Showing <%= Math.min((pagination.currentPage - 1) * 20 + 1, pagination.totalReceipts) %> to 
                                    <%= Math.min(pagination.currentPage * 20, pagination.totalReceipts) %> of 
                                    <%= pagination.totalReceipts %> receipts
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <% if (receipts.length > 0) { %>
                            <!-- Table View -->
                            <div id="tableView" class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="40px">
                                                <input type="checkbox" class="form-check-input" id="headerSelectAll">
                                            </th>
                                            <th>Receipt ID</th>
                                            <th>Date & Time</th>
                                            <th>Type</th>
                                            <th>Product</th>
                                            <th>Supplier/Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% receipts.forEach((receipt, index) => { %>
                                            <tr class="receipt-row" data-receipt-id="<%= receipt.receipt_id %>">
                                                <td>
                                                    <input type="checkbox" class="form-check-input receipt-checkbox" 
                                                           value="<%= receipt.receipt_id %>" onchange="updateBulkActions()">
                                                </td>
                                                <td>
                                                    <a href="/receipts/<%= receipt.receipt_id %>" class="text-decoration-none">
                                                        <strong><%= receipt.receipt_id %></strong>
                                                    </a>
                                                    <% if (receipt.notes) { %>
                                                        <br><small class="text-muted">
                                                            <i class="fas fa-sticky-note me-1"></i>Has notes
                                                        </small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        <%= receipt.formatted_date %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <% if (receipt.receipt_type === 'PURCHASE_RECEIPT') { %>
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-shopping-bag me-1"></i>Purchase
                                                        </span>
                                                    <% } else if (receipt.receipt_type === 'SALES_RECEIPT') { %>
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-shopping-cart me-1"></i>Sale
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (receipt.device_maker && receipt.device_name) { %>
                                                        <strong><%= receipt.device_maker %></strong><br>
                                                        <small class="text-muted"><%= receipt.device_name %></small>
                                                    <% } else { %>
                                                        <small class="text-muted">Product ID: <%= receipt.phone_id %></small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (receipt.receipt_type === 'PURCHASE_RECEIPT' && receipt.supplier_name) { %>
                                                        <i class="fas fa-truck me-1"></i><%= receipt.supplier_name %>
                                                    <% } else if (receipt.receipt_type === 'SALES_RECEIPT') { %>
                                                        <% 
                                                            const customerName = receipt.receipt_data?.customer?.name || 'Walk-in Customer';
                                                        %>
                                                        <i class="fas fa-user me-1"></i><%= customerName %>
                                                    <% } else { %>
                                                        <small class="text-muted">N/A</small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <strong class="text-success">$<%= parseFloat(receipt.total_amount).toFixed(2) %></strong>
                                                    <% if (receipt.subtotal && receipt.tax_amount) { %>
                                                        <br><small class="text-muted">
                                                            Subtotal: $<%= parseFloat(receipt.subtotal).toFixed(2) %><br>
                                                            Tax: $<%= parseFloat(receipt.tax_amount).toFixed(2) %>
                                                        </small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Completed
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="/receipts/<%= receipt.receipt_id %>" 
                                                           class="btn btn-outline-primary" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="/receipt/<%= receipt.receipt_id %>" 
                                                           class="btn btn-outline-success" target="_blank" title="Print Receipt">
                                                            <i class="fas fa-print"></i>
                                                        </a>
                                                        <button class="btn btn-outline-danger" 
                                                                onclick="deleteReceipt('<%= receipt.receipt_id %>')" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Card View -->
                            <div id="cardView" class="d-none">
                                <div class="row g-3 p-3">
                                    <% receipts.forEach(receipt => { %>
                                        <div class="col-md-6 col-lg-4">
                                            <div class="card receipt-card h-100" onclick="window.location.href='/receipts/<%= receipt.receipt_id %>'">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <span class="fw-bold"><%= receipt.receipt_id %></span>
                                                    <% if (receipt.receipt_type === 'PURCHASE_RECEIPT') { %>
                                                        <span class="badge bg-success">Purchase</span>
                                                    <% } else { %>
                                                        <span class="badge bg-primary">Sale</span>
                                                    <% } %>
                                                </div>
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <% if (receipt.device_maker && receipt.device_name) { %>
                                                            <%= receipt.device_maker %> <%= receipt.device_name %>
                                                        <% } else { %>
                                                            Product ID: <%= receipt.phone_id %>
                                                        <% } %>
                                                    </h6>
                                                    <p class="card-text">
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar me-1"></i><%= receipt.formatted_date %>
                                                        </small><br>
                                                        <% if (receipt.receipt_type === 'PURCHASE_RECEIPT' && receipt.supplier_name) { %>
                                                            <small class="text-muted">
                                                                <i class="fas fa-truck me-1"></i><%= receipt.supplier_name %>
                                                            </small>
                                                        <% } %>
                                                    </p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h5 class="text-success mb-0">$<%= parseFloat(receipt.total_amount).toFixed(2) %></h5>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="/receipt/<%= receipt.receipt_id %>" class="btn btn-outline-success" target="_blank">
                                                                <i class="fas fa-print"></i>
                                                            </a>
                                                            <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteReceipt('<%= receipt.receipt_id %>')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination.totalPages > 1) { %>
                                <div class="p-3 border-top">
                                    <nav aria-label="Receipts pagination">
                                        <ul class="pagination justify-content-center mb-0">
                                            <% if (pagination.hasPrev) { %>
                                                <li class="page-item">
                                                    <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&<%= Object.keys(filters).filter(k => filters[k]).map(k => k + '=' + encodeURIComponent(filters[k])).join('&') %>">
                                                        <i class="fas fa-chevron-left"></i> Previous
                                                    </a>
                                                </li>
                                            <% } %>
                                            
                                            <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                                                <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                                                    <a class="page-link" href="?page=<%= i %>&<%= Object.keys(filters).filter(k => filters[k]).map(k => k + '=' + encodeURIComponent(filters[k])).join('&') %>">
                                                        <%= i %>
                                                    </a>
                                                </li>
                                            <% } %>
                                            
                                            <% if (pagination.hasNext) { %>
                                                <li class="page-item">
                                                    <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&<%= Object.keys(filters).filter(k => filters[k]).map(k => k + '=' + encodeURIComponent(filters[k])).join('&') %>">
                                                        Next <i class="fas fa-chevron-right"></i>
                                                    </a>
                                                </li>
                                            <% } %>
                                        </ul>
                                    </nav>
                                </div>
                            <% } %>

                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-receipt fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">No Receipts Found</h4>
                                <p class="text-muted">No receipts match your current filters.</p>
                                <div class="mt-3">
                                    <a href="/inventory/receive" class="btn btn-success me-2">
                                        <i class="fas fa-plus me-1"></i>Create Purchase Receipt
                                    </a>
                                    <a href="/inventory/sell" class="btn btn-primary">
                                        <i class="fas fa-shopping-cart me-1"></i>Create Sales Receipt
                                    </a>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Advanced Filters Toggle
        function toggleAdvancedFilters() {
            const advanced = document.querySelector('.advanced-filters');
            advanced.style.display = advanced.style.display === 'none' ? 'block' : 'none';
        }

        // View Switching
        function switchView(viewType) {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            
            if (viewType === 'table') {
                tableView.classList.remove('d-none');
                cardView.classList.add('d-none');
            } else if (viewType === 'cards') {
                tableView.classList.add('d-none');
                cardView.classList.remove('d-none');
            }
            
            localStorage.setItem('receiptViewType', viewType);
        }

        // Load saved view preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedView = localStorage.getItem('receiptViewType') || 'table';
            switchView(savedView);
        });

        // Date Range Quick Select
        function updateDateInputs() {
            const range = document.getElementById('dateRange').value;
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            const today = new Date();
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            switch(range) {
                case 'today':
                    startDate.value = formatDate(today);
                    endDate.value = formatDate(today);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    startDate.value = formatDate(yesterday);
                    endDate.value = formatDate(yesterday);
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startDate.value = formatDate(weekStart);
                    endDate.value = formatDate(today);
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate.value = formatDate(monthStart);
                    endDate.value = formatDate(today);
                    break;
                case 'quarter':
                    const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                    startDate.value = formatDate(quarterStart);
                    endDate.value = formatDate(today);
                    break;
                case 'year':
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    startDate.value = formatDate(yearStart);
                    endDate.value = formatDate(today);
                    break;
            }
            
            if (range !== 'custom') {
                document.getElementById('filterForm').submit();
            }
        }

        // Bulk Selection
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.receipt-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.receipt-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCount.textContent = selected.length;
            bulkActions.style.display = selected.length > 0 ? 'block' : 'none';
        }

        // Bulk Operations
        function bulkExport() {
            const selected = Array.from(document.querySelectorAll('.receipt-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            
            // Implementation for bulk export
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/receipts/bulk-export';
            
            const receiptIds = document.createElement('input');
            receiptIds.type = 'hidden';
            receiptIds.name = 'receiptIds';
            receiptIds.value = JSON.stringify(selected);
            
            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = '_csrf';
            csrf.value = '<%= csrfToken %>';
            
            form.appendChild(receiptIds);
            form.appendChild(csrf);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function bulkPrint() {
            const selected = Array.from(document.querySelectorAll('.receipt-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            
            selected.forEach(receiptId => {
                window.open(`/receipt/${receiptId}`, '_blank');
            });
        }

        function bulkDelete() {
            const selected = Array.from(document.querySelectorAll('.receipt-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${selected.length} receipt(s)? This action cannot be undone.`)) {
                // Implementation for bulk delete
                fetch('/receipts/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '<%= csrfToken %>'
                    },
                    body: JSON.stringify({ receiptIds: selected })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete receipts');
                });
            }
        }

        // Export Functions
        function exportData(format) {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `/receipts/export/${format}?${params.toString()}`;
        }

        // Clear Search
        function clearSearch() {
            document.getElementById('searchTerm').value = '';
            document.getElementById('filterForm').submit();
        }

        // Delete Receipt
        function deleteReceipt(receiptId) {
            if (confirm(`Are you sure you want to delete receipt ${receiptId}? This action cannot be undone.`)) {
                fetch(`/receipts/${receiptId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '<%= csrfToken %>'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete receipt');
                });
            }
        }

        // Auto-submit form when filters change (for advanced filters)
        document.addEventListener('DOMContentLoaded', function() {
            const autoSubmitElements = ['receiptType', 'supplierId', 'phoneId', 'sortBy', 'itemsPerPage'];
            
            autoSubmitElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        document.getElementById('filterForm').submit();
                    });
                }
            });
        });
    </script>
</body>
</html>

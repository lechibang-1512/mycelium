@startuml activity-receipt-generation@startuml activity-receipt-generation@startuml activity-receipt-generation

title Activity Diagram: Receipt Generation & Export

title Activity Diagram: Receipt Generation & Exporttitle Activity Diagram: Receipt Generation & Multi-Format Export

skinparam backgroundColor #f8fafc

skinparam activityBackgroundColor #dbeafe

skinparam activityBorderColor #2b6cb0

skinparam activityFontColor #0f172askinparam backgroundColor #f8fafcskinparam backgroundColor #f8fafc



|Staff/Admin|skinparam activityBackgroundColor #dbeafeskinparam activityBackgroundColor #dbeafe

start

skinparam activityBorderColor #2b6cb0skinparam activityBorderColor #2b6cb0

if (Trigger?) then (After Transaction)

  |System|skinparam activityFontColor #0f172askinparam activityFontColor #0f172a

  :Capture Transaction Data;

  note right

    • Product details (ID, name, SKU, quantities, prices)

    • Financial details (subtotal, taxes, total)|Staff/Admin||Staff/Admin|

    • Party info (supplier or customer)

    • Location (warehouse, zone, bin)startstart

    • Batch/serial numbers (if applicable)

    • Metadata (date, user, PO number, notes)

  end note

  if (Trigger?) then (After Transaction)if (Trigger?) then (During Transaction)

  :Generate Receipt ID;

  note right  |System|  

    Format: {TYPE}-{timestamp}-{random}

    Types: PUR, SAL, RET, TRF  :Capture Transaction Data;  |System|

  end note

    note right  :Transaction Completed;

  :Store Receipt in Database;

  note right    • Product details (ID, name, SKU, quantities, prices)  :Capture Transaction Data;

    • Insert receipt header

    • Insert line items    • Financial details (subtotal, taxes, total)  

    • Generate QR code

  end note    • Party info (supplier or customer)  fork

  

  :Auto-Display Receipt;    • Location (warehouse, zone, bin)    :Gather Product Information;

  stop

    • Batch/serial numbers (if applicable)    :product_id, name, SKU;

elseif (Manual Request) then

  |Staff/Admin|    • Metadata (date, user, PO number, notes)    :quantities, prices;

  :Navigate to Receipts;

  :Select Receipt(s);  end note  fork again

  :Choose Export Action;

        :Gather Financial Details;

  |System|

  if (Export Type?) then (Single Receipt)  :Generate Receipt ID;    :subtotal, taxes, fees;

    :Load Receipt Data;

      note right    :discounts, total;

    |Staff/Admin|

    :Select Format;    Format: {TYPE}-{timestamp}-{random}  fork again

    

    |System|    Types: PUR, SAL, RET, TRF    :Gather Party Information;

    if (Format?) then (View/Print)

      :Render HTML Receipt;  end note    if (Purchase Receipt?) then (yes)

      note right

        • Receipt details        :supplier_id, supplier_name;

        • Line items table

        • Totals  :Store Receipt in Database;      :supplier contact info;

        • QR code

        • Print button  note right    else (Sales Receipt)

      end note

      stop    • Insert receipt header      :customer_name, customer_email;

      

    elseif (PDF) then    • Insert line items      :customer_phone;

      :Generate PDF Receipt;

      note right    • Generate QR code    endif

        • Use PDF library

        • Format for printing  end note  fork again

        • Include QR code

        • Add branding/logo      :Gather Warehouse/Location Data;

      end note

      :Send PDF to Browser;  :Auto-Display Receipt;    :warehouse_id, zone_id;

      stop

        stop    :bin location;

    elseif (Email) then

      :Generate PDF Receipt;  fork again

      |Staff/Admin|

      :Enter Email Address;elseif (Manual Request) then    if (Batch Tracked?) then (yes)

      |System|

      :Send Email with PDF;  |Staff/Admin|      :Gather Batch Information;

      note right

        • Attach PDF  :Navigate to Receipts;      :batch_no, lot_no;

        • Professional template

        • Company branding  :Select Receipt(s);      :expiry_date;

      end note

      :Display Success;  :Choose Export Action;    endif

      stop

          fork again

    else (JSON)

      :Generate JSON Export;  |System|    if (Serialized?) then (yes)

      note right

        Complete receipt data  if (Export Type?) then (Single Receipt)      :Gather Serial Numbers;

        in structured format

      end note    :Load Receipt Data;      :List of all serials;

      :Send to Browser;

      stop        endif

    endif

        |Staff/Admin|  fork again

  elseif (Multiple Receipts) then

    :Load Multiple Receipts;    :Select Format;    :Capture Metadata;

    

    |Staff/Admin|        :transaction_date;

    :Select Export Format;

        |System|    :performed_by_user_id;

    |System|

    if (Format?) then (PDF - Combined)    if (Format?) then (View/Print)    :PO_number (if applicable);

      :Generate Multi-Page PDF;

      note right      :Render HTML Receipt;    :notes;

        • One receipt per page

        • Table of contents      note right  end fork

        • Page numbers

      end note        • Receipt details  

      :Send to Browser;

      stop        • Line items table  |System|

      

    elseif (CSV) then        • Totals  :Check Receipt Generation Flag;

      :Generate CSV Export;

      note right        • QR code  

        • One row per receipt

        • Or one row per line item        • Print button  if (Generate Receipt Enabled?) then (yes)

        • All key fields

      end note      end note    

      :Send to Browser;

      stop      stop    :Create Receipt Record;

      

    elseif (Excel) then          

      :Generate Excel Workbook;

      note right    elseif (PDF) then    fork

        • Receipts summary sheet

        • Line items detail sheet      :Generate PDF Receipt;      :Generate Receipt ID;

        • Charts/pivot tables

        • Formatted columns      note right      note right

      end note

      :Send to Browser;        • Use PDF library        Format depends on type:

      stop

              • Format for printing        • Purchase: PUR-{timestamp}-{random}

    else (JSON)

      :Generate JSON Array;        • Include QR code        • Sales: SAL-{timestamp}-{random}

      :Send to Browser;

      stop        • Add branding/logo        • Return: RET-{timestamp}-{random}

    endif

          end note        • Transfer: TRF-{timestamp}-{random}

  else (Bulk Email)

    :Load Selected Receipts;      :Send PDF to Browser;      end note

    

    repeat      stop      

      :Get Receipt;

      :Lookup Recipient Email;          fork again

      

      if (Email Found?) then (yes)    elseif (Email) then      :Store Receipt Header;

        :Generate PDF;

        :Send Email;      :Generate PDF Receipt;      :INSERT INTO receipts

        :Mark as Sent;

      else (no)      |Staff/Admin|        (receipt_id, receipt_type,

        :Log Error;

      endif      :Enter Email Address;         receipt_data, product_id,

    repeat while (More receipts?)

          |System|         supplier_id, transaction_date,

    :Display Summary;

    note right      :Send Email with PDF;         subtotal, tax_amount, 

      X emails sent

      Y failed (list errors)      note right         total_amount, notes,

    end note

    stop        • Attach PDF         created_by, created_at)

  endif

        • Professional template        VALUES (...);

else (Analytics Export)

  |Staff/Admin|        • Company branding      

  :Navigate to Analytics;

  :Configure Report;      end note    fork again

  note right

    • Date range      :Display Success;      if (Multiple Line Items?) then (yes)

    • Filters

    • Metrics to include      stop        :Store Receipt Line Items;

  end note

                repeat

  |System|

  :Query Receipt Data;    else (JSON)          :INSERT INTO receipt_line_items

  :Aggregate Metrics;

        :Generate JSON Export;            (receipt_id, product_id,

  |Staff/Admin|

  :Select Export Format;      note right             quantity, unit_price,

  

  |System|        Complete receipt data             line_total, batch_no,

  if (Format?) then (Excel)

    :Generate Analytics Workbook;        in structured format             serial_numbers)

    note right

      • Summary dashboard      end note            VALUES (...);

      • Detailed data

      • Charts & graphs      :Send to Browser;        repeat while (more items?)

      • Pivot tables

    end note      stop      endif

    stop

        endif      

  elseif (PDF) then

    :Generate Report PDF;        fork again

    note right

      • Executive summary  elseif (Multiple Receipts) then      :Generate QR Code for Receipt;

      • Charts & visualizations

      • Data tables    :Load Multiple Receipts;      note right

      • Professional layout

    end note            QR Code contains:

    stop

        |Staff/Admin|        • Receipt ID

  else (CSV/JSON)

    :Generate Data Export;    :Select Export Format;        • Receipt Type

    stop

  endif            • Date

endif

    |System|        • Total Amount

@enduml

    if (Format?) then (PDF - Combined)        • Verification Hash

      :Generate Multi-Page PDF;      end note

      note right      

        • One receipt per page    fork again

        • Table of contents      :Log Receipt Creation;

        • Page numbers      :INSERT INTO inventory_log

      end note        (transaction_type, receipt_id, ...)

      :Send to Browser;        VALUES ('receipt_generated', ...);

      stop      

          end fork

    elseif (CSV) then    

      :Generate CSV Export;    :Receipt Record Created;

      note right    

        • One row per receipt  endif

        • Or one row per line item

        • All key fieldselse (Manual Receipt Generation)

      end note  

      :Send to Browser;  |Staff/Admin|

      stop  :Navigate to Receipts;

        :Select Transaction/Receipt;

    elseif (Excel) then  :Click "Generate/Regenerate Receipt";

      :Generate Excel Workbook;  

      note right  |System|

        • Receipts summary sheet  :Load Transaction Data;

        • Line items detail sheet  :Load Receipt Record;

        • Charts/pivot tables  

        • Formatted columnselse (Bulk Export)

      end note  

      :Send to Browser;  |Staff/Admin|

      stop  :Navigate to Receipts;

        :Apply Filters;

    else (JSON)  note right

      :Generate JSON Array;    Filter options:

      :Send to Browser;    • Date range

      stop    • Receipt type

    endif    • Customer/Supplier

        • Warehouse

  else (Bulk Email)    • Amount range

    :Load Selected Receipts;    • Status

      end note

    repeat  :Select Receipts;

      :Get Receipt;  :Click "Bulk Export";

      :Lookup Recipient Email;  

        |System|

      if (Email Found?) then (yes)  :Load Multiple Receipts;

        :Generate PDF;  :Aggregate receipt data;

        :Send Email;  

        :Mark as Sent;endif

      else (no)

        :Log Error;|System|

      endif:Display Format Selection;

    repeat while (More receipts?)

    |Staff/Admin|

    :Display Summary;:Choose Export Format;

    note right

      X emails sent|System|

      Y failed (list errors)if (Format?) then (Print View)

    end note  

    stop  :Generate HTML Print View;

  endif  

  fork

else (Analytics Export)    :Create Receipt Header;

  |Staff/Admin|    :Company logo & info;

  :Navigate to Analytics;    :Receipt type & number;

  :Configure Report;    :Date & time;

  note right  fork again

    • Date range    :Create Customer/Supplier Section;

    • Filters    :Name, address, contact;

    • Metrics to include  fork again

  end note    :Create Line Items Table;

      :Columns: Item, Qty, Price, Total;

  |System|    :Include batch/serial if applicable;

  :Query Receipt Data;  fork again

  :Aggregate Metrics;    :Create Financial Summary;

      :Subtotal;

  |Staff/Admin|    :Taxes breakdown;

  :Select Export Format;    :Discounts;

      :Fees;

  |System|    :Total (bold/large);

  if (Format?) then (Excel)  fork again

    :Generate Analytics Workbook;    :Add QR Code;

    note right    :Embed as <img> base64;

      • Summary dashboard  fork again

      • Detailed data    :Add Footer;

      • Charts & graphs    :Terms & conditions;

      • Pivot tables    :Thank you message;

    end note    :Company contact info;

    stop  fork again

        :Apply Print Styles;

  elseif (PDF) then    :CSS for print media;

    :Generate Report PDF;    :Page breaks;

    note right    :Font sizes;

      • Executive summary  end fork

      • Charts & visualizations  

      • Data tables  :Render in Browser;

      • Professional layout  :Trigger Print Dialog;

    end note  

    stop  |Staff/Admin|

      :Print Receipt;

  else (CSV/JSON)  :Or Save as PDF from browser;

    :Generate Data Export;  

    stop  stop

  endif

endifelse (PDF Export)

  

@enduml  :Initialize PDF Generator;

  note right
    Using library like:
    • PDFKit
    • pdfmake
    • html-pdf
  end note
  
  fork
    :Create PDF Document;
    :Set page size (A4/Letter);
    :Set margins;
    
  fork again
    :Add Company Header;
    :Logo (if available);
    :Company name & address;
    :Contact information;
    
  fork again
    :Add Receipt Title;
    :Receipt type (large);
    :Receipt number;
    :Date & time;
    
  fork again
    :Add Party Details;
    if (Purchase?) then (yes)
      :Supplier information;
    else (Sales)
      :Customer information;
    endif
    
  fork again
    :Add Warehouse/Location;
    :Warehouse name;
    :Zone and bin;
    
  fork again
    :Create Items Table;
    :Headers: Description, Qty, Unit Price, Total;
    :Borders and styling;
    
    repeat
      :Add Line Item Row;
      :Product name & SKU;
      :Quantity;
      :Unit price;
      :Line total;
      if (Batch/Serial?) then (yes)
        :Add sub-row with batch/serial info;
      endif
    repeat while (more items?)
    
  fork again
    :Add Financial Summary;
    :Right-aligned;
    :Subtotal row;
    if (Taxes?) then (yes)
      :Tax rows (itemized);
    endif
    if (Discounts?) then (yes)
      :Discount rows;
    endif
    if (Fees?) then (yes)
      :Fee rows;
    endif
    :Total row (bold, larger font);
    
  fork again
    :Add QR Code;
    :Position: bottom right;
    :Size: 100x100 pixels;
    
  fork again
    :Add Notes Section;
    if (Notes Exist?) then (yes)
      :Notes: {note_text};
    endif
    
  fork again
    :Add Footer;
    :Terms and conditions;
    :Authorized signature line;
    :Page numbers;
    
  end fork
  
  :Generate PDF Binary;
  
  if (Delivery Method?) then (Download)
    :Set Response Headers;
    :Content-Type: application/pdf;
    :Content-Disposition: attachment;
    :filename: receipt_{receipt_id}.pdf;
    
    :Send PDF to Browser;
    
    |Staff/Admin|
    :Download PDF File;
    stop
    
  else (Email)
    :Prepare Email;
    :to: customer_email or supplier_email;
    :subject: Receipt {receipt_id};
    :body: Professional message;
    :attachment: PDF file;
    
    :Send Email;
    :Log email sent;
    
    :Display Success Message;
    stop
    
  else (Store on Server)
    :Save to Receipts Directory;
    :path: /receipts/{year}/{month}/{receipt_id}.pdf;
    :Set file permissions;
    
    :Store File Path in Database;
    :UPDATE receipts
      SET pdf_file_path = ?
      WHERE receipt_id = ?;
    
    :Return File URL;
    stop
  endif

else (Excel/CSV Export)
  
  if (Single Receipt?) then (yes)
    :Create Receipt Detail Sheet;
    
    fork
      :Sheet 1: Receipt Header;
      :Key-value pairs;
      :Receipt ID, Date, Type, Total;
      
    fork again
      :Sheet 2: Line Items;
      :Tabular format;
      :Headers: Product, SKU, Qty, Price, Total;
      
      repeat
        :Add row for each line item;
      repeat while (more items?)
      
    fork again
      :Sheet 3: Financial Summary;
      :Subtotal;
      :Taxes (itemized);
      :Discounts;
      :Fees;
      :Grand Total;
      
    end fork
    
  else (Multiple Receipts)
    :Create Summary Spreadsheet;
    
    fork
      :Sheet: All Receipts;
      :Headers: Receipt ID, Date, Type, 
               Customer/Supplier, Items, 
               Subtotal, Tax, Total;
      
      repeat
        :Add row for each receipt;
        :Summarize line items;
      repeat while (more receipts?)
      
    fork again
      :Sheet: Financial Summary;
      :Total sales/purchases;
      :Total tax collected/paid;
      :Count by type;
      :Average transaction value;
      
    fork again
      if (Include Details?) then (yes)
        :Sheet: All Line Items;
        :Headers: Receipt ID, Product, SKU,
                 Qty, Price, Total;
        
        repeat
          repeat
            :Add row for each line item;
          repeat while (more items in receipt?)
        repeat while (more receipts?)
      endif
      
    end fork
    
  endif
  
  if (Format = Excel?) then (yes)
    :Generate XLSX file;
    :using xlsx library;
    :Apply formatting;
    :Auto-column width;
    :Freeze header row;
    :Apply cell formatting;
    
    :Set Response Headers;
    :Content-Type: application/vnd.openxmlformats;
    
  else (CSV)
    :Generate CSV file;
    :Comma-separated values;
    :Proper escaping;
    :UTF-8 encoding;
    
    :Set Response Headers;
    :Content-Type: text/csv;
  endif
  
  :Send File to Browser;
  
  |Staff/Admin|
  :Download Spreadsheet;
  :Open in Excel/Google Sheets;
  
  stop

else (JSON Export)
  
  :Generate JSON Structure;
  
  if (Single Receipt?) then (yes)
    :Create receipt object;
    :Include all nested data;
    note right
      {
        "receipt_id": "...",
        "receipt_type": "...",
        "date": "...",
        "customer": {...},
        "line_items": [...],
        "financial": {
          "subtotal": ...,
          "tax": ...,
          "total": ...
        },
        "metadata": {...}
      }
    end note
    
  else (Multiple)
    :Create array of receipts;
    :Include summary statistics;
  endif
  
  :Set Response Headers;
  :Content-Type: application/json;
  
  :Send JSON Response;
  
  |Staff/Admin|
  :Receive JSON Data;
  :Use for API integration;
  :Or import to other system;
  
  stop

else (Email Receipt)
  
  :Generate HTML Email Template;
  
  fork
    :Create Responsive HTML;
    :Inline CSS styles;
    :Mobile-friendly layout;
    
  fork again
    :Add Company Branding;
    :Logo and colors;
    
  fork again
    :Add Receipt Content;
    :All details in clean format;
    
  fork again
    :Add Call-to-Action Buttons;
    :"View Online";
    :"Download PDF";
    :"Contact Support";
    
  fork again
    :Attach PDF Version;
    :Generate PDF as above;
    :Add as email attachment;
    
  end fork
  
  :Send Email;
  
  fork
    :to: customer_email;
  fork again
    :subject: Your Receipt #{receipt_id};
  fork again
    :body: HTML template;
  fork again
    :attachments: [receipt.pdf];
  fork again
    :Log email sent;
    :INSERT INTO email_log
      (receipt_id, recipient, 
       sent_at, status)
      VALUES (...);
  end fork
  
  :Display Success Message;
  stop

endif

@enduml
